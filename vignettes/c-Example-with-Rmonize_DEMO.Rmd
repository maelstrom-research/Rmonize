---
title: "Example with Rmonize_DEMO"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example with Rmonize_DEMO}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = T,
  results = "hide",
  eval = FALSE)

```

# Get started

## Install the package

```{r, eval=FALSE}
# To install Rmonize:
install.packages('Rmonize')

library(Rmonize)
# If you need help with the package, please use:
Rmonize_help()

# Downloadable templates are available here
Rmonize_templates()

# Demo files are available here, along with an online demonstration process 
Rmonize_DEMO()

```

## Rmonize_DEMO objets
Demonstration elements are available in the built-in Rmonize_DEMO object. 
These provide illustrative examples of the main inputs and are used to run 
commands in this vignette. 


```{r}

names(Rmonize_DEMO)
# To see examples
# View(Rmonize_DEMO$data_dict_TOKYO)   # A data dictionary
# View(Rmonize_DEMO$dataset_TOKYO)                      # A datasets
# View(Rmonize_DEMO$`data_processing_elements - final`) # A Data Processing Elements
# View(Rmonize_DEMO$`dataschema - final`)               # A DataSchema 
                  
```


# General objective of this demonstration

A general process with **Rmonize** involves the following steps:

 * Associate input datasets with their data dictionaries.
 * Prepare a “dossier” of input datasets and data dictionaries.
 * Harmonize a dossier of datasets using the DataSchema and 
   Data Processing Elements.
 * Review the dossier of harmonized datasets.
 
The process is demonstrated below with all inputs in valid formats and no 
errors, i.e., assuming that the content and structure of all inputs are 
compatible with **Rmonize**. Error-checking and other manipulations of inputs 
will be covered in other vignettes.


## Prepare the inputs

If input data dictionaries are available, they can be associated with 
their corresponding datasets using the function `data_dict_apply`. If not 
provided, minimal data dictionaries will automatically be created to meet 
technical requirements of the following functions. 
The input datasets and associated data dictionaries are then grouped 
into a dossier.

```{r}
# Associate metadata from data dictionary to the the data

dataset_MELBOURNE <- data_dict_apply(
  dataset = Rmonize_DEMO$dataset_MELBOURNE,
  data_dict = Rmonize_DEMO$data_dict_MELBOURNE)

dataset_PARIS <- data_dict_apply(
  dataset = Rmonize_DEMO$dataset_PARIS,
  data_dict = Rmonize_DEMO$data_dict_PARIS)

dataset_TOKYO <- data_dict_apply(
  dataset = Rmonize_DEMO$dataset_TOKYO,
  data_dict = Rmonize_DEMO$data_dict_TOKYO)

```


## Generate harmonized data
When the main inputs (dossier, DataSchema, and Data Processing Elements) are 
prepared, 

```{r}
# Group the dataset in a dossier object
# NB: The names of the datasets in the dossier must match the column 
# input_dataset in the Data Processing Elements

dossier <- dossier_create(
  dataset_list = list(
    dataset_MELBOURNE, 
    dataset_PARIS, 
    dataset_TOKYO))

dataschema <- Rmonize_DEMO$`dataschema - final`
data_proc_elem <- Rmonize_DEMO$`data_processing_elements - final`

```

You can proceed with harmonization using `harmo_process`.

```{r}

# Data processing

harmonized_dossier <- harmo_process(dossier, dataschema, data_proc_elem)
show_harmo_error(harmonized_dossier)

```


## Assess harmonized data
You can then assess and summarize the harmonized data to identify potential 
issues, produce summary statistics, and generate visual reports.

**Warning ⚠** *This tutorial creates a folder 'tmp' where the visual report is generated.*

```{r}

# These reports can be downloaded as Excel files
harmonized_dossier_evaluate <- harmonized_dossier_evaluate(harmonized_dossier)
harmonized_dossier_summary <- harmonized_dossier_summarize(harmonized_dossier)

bookdown_path <- paste0('tmp/',basename(tempdir()))

harmonized_dossier_visualize(
  harmonized_dossier, 
  bookdown_path = bookdown_path,
  group_by = 'adm_study')

```

